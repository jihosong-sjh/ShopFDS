# Alertmanager Configuration for ShopFDS
# Purpose: Route alerts to Slack, Email, and other notification channels

global:
  # Global configuration
  resolve_timeout: 5m
  
  # Slack webhook URL (set via environment variable)
  slack_api_url: "${SLACK_WEBHOOK_URL}"
  
  # SMTP configuration for email alerts
  smtp_smarthost: "${SMTP_HOST:smtp.gmail.com:587}"
  smtp_from: "${SMTP_FROM:alerts@shopfds.com}"
  smtp_auth_username: "${SMTP_USERNAME}"
  smtp_auth_password: "${SMTP_PASSWORD}"
  smtp_require_tls: true

# Alert routing tree
route:
  # Default receiver for all alerts
  receiver: "default"
  
  # Group alerts by these labels
  group_by: ["alertname", "cluster", "service"]
  
  # Wait time before sending first notification
  group_wait: 10s
  
  # Wait time before sending notification about new alerts
  group_interval: 10s
  
  # Wait time before re-sending notification
  repeat_interval: 12h
  
  # Child routes for specific alert types
  routes:
    # Critical alerts go to multiple channels
    - receiver: "critical-alerts"
      match:
        severity: critical
      continue: true
    
    # Infrastructure alerts
    - receiver: "infrastructure-team"
      match:
        component: infrastructure
      group_wait: 30s
      repeat_interval: 4h
    
    # Database alerts
    - receiver: "database-team"
      match:
        component: database
      group_wait: 10s
      repeat_interval: 2h
    
    # Application alerts
    - receiver: "application-team"
      match:
        component: application
      group_wait: 30s
      repeat_interval: 6h
    
    # FDS-specific alerts
    - receiver: "fds-team"
      match:
        component: fds
      group_wait: 1m
      repeat_interval: 4h
    
    # Worker/Celery alerts
    - receiver: "worker-team"
      match:
        component: worker
      group_wait: 2m
      repeat_interval: 4h

# Inhibition rules (suppress alerts when others are firing)
inhibit_rules:
  # Suppress warning alerts if critical alert is firing
  - source_match:
      severity: critical
    target_match:
      severity: warning
    equal: ["alertname", "cluster", "service"]
  
  # Suppress all alerts if service is down
  - source_match:
      alertname: HealthCheckFailing
    target_match_re:
      severity: warning|info
    equal: ["service"]

# Notification receivers
receivers:
  # Default receiver (Slack only)
  - name: "default"
    slack_configs:
      - channel: "#shopfds-alerts"
        title: "[{{ .Status | toUpper }}] {{ .GroupLabels.alertname }}"
        text: >-
          {{ range .Alerts }}
            *Alert:* {{ .Labels.alertname }}
            *Severity:* {{ .Labels.severity }}
            *Component:* {{ .Labels.component }}
            *Summary:* {{ .Annotations.summary }}
            *Description:* {{ .Annotations.description }}
          {{ end }}
        send_resolved: true
  
  # Critical alerts (Slack + Email + PagerDuty)
  - name: "critical-alerts"
    slack_configs:
      - channel: "#shopfds-critical"
        title: "[CRITICAL] {{ .GroupLabels.alertname }}"
        text: >-
          *[CRITICAL ALERT]*
          {{ range .Alerts }}
            *Alert:* {{ .Labels.alertname }}
            *Service:* {{ .Labels.service }}
            *Summary:* {{ .Annotations.summary }}
            *Description:* {{ .Annotations.description }}
          {{ end }}
        send_resolved: true
        color: "danger"
    
    email_configs:
      - to: "${CRITICAL_ALERT_EMAIL:ops-team@shopfds.com}"
        headers:
          Subject: "[CRITICAL] ShopFDS Alert: {{ .GroupLabels.alertname }}"
        html: |
          <h2>Critical Alert Fired</h2>
          {{ range .Alerts }}
          <p>
            <strong>Alert:</strong> {{ .Labels.alertname }}<br>
            <strong>Service:</strong> {{ .Labels.service }}<br>
            <strong>Severity:</strong> {{ .Labels.severity }}<br>
            <strong>Summary:</strong> {{ .Annotations.summary }}<br>
            <strong>Description:</strong> {{ .Annotations.description }}<br>
          </p>
          {{ end }}
  
  # Infrastructure team
  - name: "infrastructure-team"
    slack_configs:
      - channel: "#shopfds-infra"
        title: "[{{ .Status | toUpper }}] Infrastructure Alert"
        text: >-
          {{ range .Alerts }}
            *Alert:* {{ .Labels.alertname }}
            *Instance:* {{ .Labels.instance }}
            *Summary:* {{ .Annotations.summary }}
            *Description:* {{ .Annotations.description }}
          {{ end }}
        send_resolved: true
  
  # Database team
  - name: "database-team"
    slack_configs:
      - channel: "#shopfds-database"
        title: "[{{ .Status | toUpper }}] Database Alert"
        text: >-
          {{ range .Alerts }}
            *Alert:* {{ .Labels.alertname }}
            *Instance:* {{ .Labels.instance }}
            *Summary:* {{ .Annotations.summary }}
            *Description:* {{ .Annotations.description }}
          {{ end }}
        send_resolved: true
  
  # Application team
  - name: "application-team"
    slack_configs:
      - channel: "#shopfds-app"
        title: "[{{ .Status | toUpper }}] Application Alert"
        text: >-
          {{ range .Alerts }}
            *Alert:* {{ .Labels.alertname }}
            *Service:* {{ .Labels.service }}
            *Endpoint:* {{ .Labels.endpoint }}
            *Summary:* {{ .Annotations.summary }}
            *Description:* {{ .Annotations.description }}
          {{ end }}
        send_resolved: true
  
  # FDS team
  - name: "fds-team"
    slack_configs:
      - channel: "#shopfds-fds"
        title: "[{{ .Status | toUpper }}] FDS Alert"
        text: >-
          {{ range .Alerts }}
            *Alert:* {{ .Labels.alertname }}
            *Summary:* {{ .Annotations.summary }}
            *Description:* {{ .Annotations.description }}
          {{ end }}
        send_resolved: true
  
  # Worker team
  - name: "worker-team"
    slack_configs:
      - channel: "#shopfds-workers"
        title: "[{{ .Status | toUpper }}] Celery Worker Alert"
        text: >-
          {{ range .Alerts }}
            *Alert:* {{ .Labels.alertname }}
            *Queue:* {{ .Labels.queue }}
            *Summary:* {{ .Annotations.summary }}
            *Description:* {{ .Annotations.description }}
          {{ end }}
        send_resolved: true

# Templates for notifications
templates:
  - '/etc/alertmanager/templates/*.tmpl'
