# Nginx Rate Limiting 설정
# 위치: /etc/nginx/conf.d/rate-limiting.conf

# Rate Limiting Zones 정의
# zone=NAME:SIZE - 공유 메모리 존 설정
# rate=R requests/second

# 1. IP 기반 일반 Rate Limiting (100 req/min = 1.67 req/s)
limit_req_zone $binary_remote_addr zone=general:10m rate=100r/m;

# 2. 인증 엔드포인트 Rate Limiting (10 req/15min = 0.011 req/s)
limit_req_zone $binary_remote_addr zone=auth:10m rate=10r/15m;

# 3. 주문 API Rate Limiting (30 req/min = 0.5 req/s)
limit_req_zone $binary_remote_addr zone=orders:10m rate=30r/m;

# 4. 정적 파일 Rate Limiting (1000 req/min = 16.67 req/s)
limit_req_zone $binary_remote_addr zone=static:10m rate=1000r/m;

# 5. Connection Limit (동시 연결 수 제한)
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;


# 서버 블록 설정
server {
    listen 80;
    server_name api.shopfds.local;

    # 전역 Rate Limiting 적용 (일반 API)
    location / {
        # 기본 Rate Limit: 100 req/min, burst 20개 허용
        limit_req zone=general burst=20 nodelay;

        # 동시 연결 수 제한: IP당 10개
        limit_conn conn_limit 10;

        # Rate Limit 초과 시 응답 코드
        limit_req_status 429;
        limit_conn_status 429;

        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 인증 엔드포인트 (더 엄격한 제한)
    location /v1/auth/register {
        # 10 req/15min, burst 5개 허용
        limit_req zone=auth burst=5 nodelay;
        limit_conn conn_limit 5;
        limit_req_status 429;

        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /v1/auth/login {
        # 10 req/15min, burst 5개 허용
        limit_req zone=auth burst=5 nodelay;
        limit_conn conn_limit 5;
        limit_req_status 429;

        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /v1/auth/request-otp {
        # 3 req/5min (더 엄격)
        limit_req zone=auth burst=2 nodelay;
        limit_conn conn_limit 3;
        limit_req_status 429;

        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 주문 엔드포인트 (중간 제한)
    location /v1/orders {
        # 30 req/min, burst 10개 허용
        limit_req zone=orders burst=10 nodelay;
        limit_conn conn_limit 10;
        limit_req_status 429;

        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 정적 파일 (관대한 제한)
    location /static/ {
        # 1000 req/min, burst 50개 허용
        limit_req zone=static burst=50 nodelay;
        limit_conn conn_limit 20;

        alias /var/www/static/;
    }

    # Health Check (Rate Limiting 제외)
    location /health {
        # Health Check는 Rate Limiting 적용 안 함
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
    }

    # Metrics (Rate Limiting 제외)
    location /metrics {
        # Prometheus Metrics는 Rate Limiting 적용 안 함
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
    }

    # Rate Limit 초과 시 커스텀 에러 페이지
    error_page 429 @too_many_requests;
    location @too_many_requests {
        default_type application/json;
        return 429 '{"error": "Too Many Requests", "message": "Rate limit exceeded. Please try again later.", "status": 429}';
    }
}


# FDS 서비스 (더 관대한 제한)
server {
    listen 80;
    server_name fds.shopfds.local;

    location / {
        # FDS 내부 통신은 덜 엄격 (1000 req/min)
        limit_req zone=general burst=50 nodelay;
        limit_conn conn_limit 50;

        proxy_pass http://fds:8001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}


# 관리자 대시보드 (중간 제한)
server {
    listen 80;
    server_name admin.shopfds.local;

    location / {
        # 관리자는 30 req/min
        limit_req zone=orders burst=10 nodelay;
        limit_conn conn_limit 10;

        proxy_pass http://admin-dashboard:8002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}


# HTTPS 설정 (프로덕션 환경)
# server {
#     listen 443 ssl http2;
#     server_name api.shopfds.com;
#
#     ssl_certificate /etc/nginx/ssl/cert.pem;
#     ssl_certificate_key /etc/nginx/ssl/key.pem;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#
#     # Rate Limiting 설정 동일하게 적용
#     location / {
#         limit_req zone=general burst=20 nodelay;
#         limit_conn conn_limit 10;
#         proxy_pass http://backend:8000;
#         # ...
#     }
# }


# Rate Limiting 설정 팁:
# 1. burst: 일시적 트래픽 급증 허용 (큐 크기)
# 2. nodelay: burst 요청도 즉시 처리 (delay 없음)
# 3. zone 크기: 10m = 약 160,000개 IP 추적 가능
# 4. $binary_remote_addr: IPv4는 4바이트, IPv6는 16바이트
# 5. rate: r/s (초당), r/m (분당), r/h (시간당)

# 테스트 방법:
# ab -n 100 -c 10 http://api.shopfds.local/v1/products
# wrk -t4 -c100 -d30s http://api.shopfds.local/
