# PostgreSQL Replica (Standby) Configuration
# Streaming Replication Setup
# Feature: 002-production-infra
# Reference: specs/002-production-infra/data-model.md

# --- Hot Standby Settings ---
# Enable read-only queries on replica
hot_standby = on

# Maximum delay before canceling conflicting queries on replica (30s)
max_standby_streaming_delay = 30s

# Allow feedback to master about queries running on replica
hot_standby_feedback = on

# --- Recovery Settings ---
# These settings are typically in standby.signal and recovery.conf (PostgreSQL 12+)
# For PostgreSQL 12+, create a standby.signal file in data directory
# and set primary_conninfo in postgresql.auto.conf

# Primary connection info (set via environment variables in docker-compose)
# primary_conninfo = 'host=postgres-master port=5432 user=replicator password=replicator_password application_name=replica-node-1'

# Slot name for replication slot (optional, for failover protection)
# primary_slot_name = 'replica_slot_1'

# --- Connection Settings ---
listen_addresses = '*'
max_connections = 200

# --- Performance Settings (same as master) ---
shared_buffers = 2GB
effective_cache_size = 6GB
maintenance_work_mem = 512MB
work_mem = 16MB

# --- WAL Settings ---
# Replica also needs wal_level for cascading replication (optional)
wal_level = replica

# Allow replica to become a master later (for failover)
# Must be >= master's max_wal_senders (5)
max_wal_senders = 5
max_replication_slots = 5

# --- Logging ---
log_destination = 'stderr'
logging_collector = off  # Disable file logging for Docker (use stderr for docker logs)
# log_directory = 'log'
# log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
# log_rotation_age = 1d
# log_rotation_size = 100MB
log_min_duration_statement = 1000
log_line_prefix = '%m [%p] %u@%d [REPLICA] '
log_timezone = 'UTC'

# Log replication-related messages
log_replication_commands = on

# --- Autovacuum (still needed on replicas for catalog tables) ---
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min

# --- Locale and Formatting ---
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

# --- Read-Only Optimization ---
# Since replicas are read-only, we can tune for read performance
random_page_cost = 1.1  # Faster for SSD storage
effective_io_concurrency = 200  # Higher for SSD

# --- Extensions ---
# Preload TimescaleDB extension (must match master)
shared_preload_libraries = 'timescaledb'

# --- Monitoring ---
# Enable query statistics (useful for monitoring read queries)
# pg_stat_statements can be added after timescaledb if needed:
# shared_preload_libraries = 'timescaledb,pg_stat_statements'
