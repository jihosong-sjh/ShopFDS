# PostgreSQL Master Configuration
# Streaming Replication Setup
# Feature: 002-production-infra
# Reference: specs/002-production-infra/data-model.md

# --- WAL (Write-Ahead Logging) Settings ---
# Enable streaming replication
wal_level = replica

# Number of concurrent connections from replicas
max_wal_senders = 5

# Maximum number of replication slots (failover protection)
max_replication_slots = 5

# Amount of WAL data to retain in pg_wal (16MB segments)
wal_keep_size = 1GB

# --- Archiving Settings ---
# Archive mode for point-in-time recovery (optional)
archive_mode = on
archive_command = 'test ! -f /var/lib/postgresql/wal_archive/%f && cp %p /var/lib/postgresql/wal_archive/%f'

# --- Checkpoints ---
# Checkpoint timeout (longer = better performance, more recovery time)
checkpoint_timeout = 10min

# Maximum checkpoint completion time (fraction of checkpoint_timeout)
checkpoint_completion_target = 0.9

# --- Connection Settings ---
# Allow replication connections from replicas
# pg_hba.conf must also allow replication connections
listen_addresses = '*'
max_connections = 200

# --- Performance Settings ---
# Shared memory for caching (25% of available RAM)
shared_buffers = 2GB

# Effective cache size (50-75% of available RAM)
effective_cache_size = 6GB

# Maintenance work memory (for vacuuming, index creation)
maintenance_work_mem = 512MB

# Working memory per query operation (sort, hash)
work_mem = 16MB

# --- Logging ---
log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 1000  # Log queries slower than 1 second
log_line_prefix = '%m [%p] %u@%d '
log_timezone = 'UTC'

# --- Replication Monitoring ---
# Log replication lag (useful for monitoring)
log_replication_commands = on

# Synchronous commit (async for better performance)
synchronous_commit = off

# --- Autovacuum ---
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min

# --- Locale and Formatting ---
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'
