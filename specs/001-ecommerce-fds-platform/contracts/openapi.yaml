openapi: 3.0.3
info:
  title: 이커머스 FDS 플랫폼 API
  description: |
    AI/ML 기반 사기 탐지 시스템을 통합한 이커머스 플랫폼 API

    **인증 방식**: JWT Bearer Token
    - Access Token: 15분 유효
    - Refresh Token: 7일 유효

    **Rate Limiting**:
    - 인증 API: 10 requests/min
    - 일반 API: 100 requests/min
    - FDS API: 1000 requests/min
  version: 1.0.0
  contact:
    name: API Support
    email: api@shopfds.com

servers:
  - url: https://api.shopfds.com/v1
    description: Production
  - url: https://staging-api.shopfds.com/v1
    description: Staging
  - url: http://localhost:8000/v1
    description: Local Development

tags:
  - name: Auth
    description: 인증 및 인가
  - name: Users
    description: 사용자 관리
  - name: Products
    description: 상품 관리
  - name: Cart
    description: 장바구니
  - name: Orders
    description: 주문 관리
  - name: Payments
    description: 결제 관리
  - name: FDS
    description: 사기 탐지 시스템
  - name: Admin
    description: 관리자 기능

security:
  - bearerAuth: []

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # ===== 공통 스키마 =====
    Error:
      type: object
      properties:
        error_code:
          type: string
          example: "VALIDATION_ERROR"
        message:
          type: string
          example: "이메일 형식이 올바르지 않습니다."
        details:
          type: object
          nullable: true

    PaginationMeta:
      type: object
      properties:
        page:
          type: integer
          example: 1
        per_page:
          type: integer
          example: 20
        total_items:
          type: integer
          example: 150
        total_pages:
          type: integer
          example: 8

    # ===== 사용자 스키마 =====
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        name:
          type: string
        role:
          type: string
          enum: [customer, admin, security_team]
        status:
          type: string
          enum: [active, suspended, deleted]
        created_at:
          type: string
          format: date-time
        last_login_at:
          type: string
          format: date-time
          nullable: true

    # ===== 상품 스키마 =====
    Product:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
          nullable: true
        price:
          type: number
          format: decimal
          example: 49900
        stock_quantity:
          type: integer
          example: 150
        category:
          type: string
          example: "전자제품"
        image_url:
          type: string
          format: uri
          nullable: true
        status:
          type: string
          enum: [available, out_of_stock, discontinued]
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    # ===== 장바구니 스키마 =====
    Cart:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        items:
          type: array
          items:
            $ref: '#/components/schemas/CartItem'
        total_amount:
          type: number
          format: decimal
          example: 199600
        updated_at:
          type: string
          format: date-time

    CartItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        product_id:
          type: string
          format: uuid
        product_name:
          type: string
        product_price:
          type: number
          format: decimal
        quantity:
          type: integer
          minimum: 1
        subtotal:
          type: number
          format: decimal
        added_at:
          type: string
          format: date-time

    # ===== 주문 스키마 =====
    Order:
      type: object
      properties:
        id:
          type: string
          format: uuid
        order_number:
          type: string
          example: "ORD-20251113-001"
        user_id:
          type: string
          format: uuid
        total_amount:
          type: number
          format: decimal
        status:
          type: string
          enum: [pending, paid, preparing, shipped, delivered, cancelled, refunded]
        shipping_name:
          type: string
        shipping_address:
          type: string
        shipping_phone:
          type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItem'
        created_at:
          type: string
          format: date-time
        paid_at:
          type: string
          format: date-time
          nullable: true

    OrderItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        product_id:
          type: string
          format: uuid
        product_name:
          type: string
        quantity:
          type: integer
        unit_price:
          type: number
          format: decimal
        subtotal:
          type: number
          format: decimal

    # ===== 결제 스키마 =====
    Payment:
      type: object
      properties:
        id:
          type: string
          format: uuid
        order_id:
          type: string
          format: uuid
        payment_method:
          type: string
          enum: [credit_card]
        amount:
          type: number
          format: decimal
        status:
          type: string
          enum: [pending, completed, failed, refunded]
        card_last_four:
          type: string
          example: "1234"
        transaction_id:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true

    # ===== FDS 스키마 =====
    Transaction:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        order_id:
          type: string
          format: uuid
        amount:
          type: number
          format: decimal
        ip_address:
          type: string
          format: ipv4
        device_type:
          type: string
          enum: [desktop, mobile, tablet, unknown]
        risk_score:
          type: integer
          minimum: 0
          maximum: 100
        risk_level:
          type: string
          enum: [low, medium, high]
        evaluation_status:
          type: string
          enum: [evaluating, approved, blocked, manual_review]
        evaluation_time_ms:
          type: integer
          description: "FDS 평가 소요 시간 (목표: 100ms 이내)"
        risk_factors:
          type: array
          items:
            $ref: '#/components/schemas/RiskFactor'
        created_at:
          type: string
          format: date-time

    RiskFactor:
      type: object
      properties:
        factor_type:
          type: string
          enum: [velocity_check, amount_threshold, location_mismatch, suspicious_ip, suspicious_time, ml_anomaly, stolen_card]
        factor_score:
          type: integer
          minimum: 0
          maximum: 100
        description:
          type: string
          example: "동일 IP에서 5분 내 3회 거래 시도"

paths:
  # ===== 인증 API =====
  /auth/register:
    post:
      tags: [Auth]
      summary: 회원가입
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password, name]
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 8
                  description: "최소 8자, 대소문자+숫자+특수문자 포함"
                name:
                  type: string
                  minLength: 2
                  maxLength: 100
      responses:
        '201':
          description: 회원가입 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
                  access_token:
                    type: string
                  refresh_token:
                    type: string
        '400':
          description: 유효성 검증 실패
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/login:
    post:
      tags: [Auth]
      summary: 로그인
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
      responses:
        '200':
          description: 로그인 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
                  access_token:
                    type: string
                  refresh_token:
                    type: string
        '401':
          description: 인증 실패
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ===== 상품 API =====
  /products:
    get:
      tags: [Products]
      summary: 상품 목록 조회
      security: []
      parameters:
        - in: query
          name: category
          schema:
            type: string
          description: 카테고리 필터
        - in: query
          name: search
          schema:
            type: string
          description: 상품명 검색
        - in: query
          name: page
          schema:
            type: integer
            default: 1
        - in: query
          name: per_page
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: 상품 목록
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Product'
                  meta:
                    $ref: '#/components/schemas/PaginationMeta'

  /products/{product_id}:
    get:
      tags: [Products]
      summary: 상품 상세 조회
      security: []
      parameters:
        - in: path
          name: product_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 상품 상세
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'
        '404':
          description: 상품을 찾을 수 없음

  # ===== 장바구니 API =====
  /cart:
    get:
      tags: [Cart]
      summary: 내 장바구니 조회
      responses:
        '200':
          description: 장바구니
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cart'

  /cart/items:
    post:
      tags: [Cart]
      summary: 장바구니에 상품 추가
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [product_id, quantity]
              properties:
                product_id:
                  type: string
                  format: uuid
                quantity:
                  type: integer
                  minimum: 1
      responses:
        '201':
          description: 추가 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cart'

  /cart/items/{item_id}:
    patch:
      tags: [Cart]
      summary: 장바구니 항목 수량 변경
      parameters:
        - in: path
          name: item_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [quantity]
              properties:
                quantity:
                  type: integer
                  minimum: 1
      responses:
        '200':
          description: 수정 성공
    delete:
      tags: [Cart]
      summary: 장바구니 항목 삭제
      parameters:
        - in: path
          name: item_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: 삭제 성공

  # ===== 주문 API =====
  /orders:
    post:
      tags: [Orders]
      summary: 주문 생성 (체크아웃)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [shipping_name, shipping_address, shipping_phone, payment_info]
              properties:
                shipping_name:
                  type: string
                shipping_address:
                  type: string
                shipping_phone:
                  type: string
                  pattern: '^\d{3}-\d{4}-\d{4}$'
                payment_info:
                  type: object
                  required: [card_number, card_expiry, card_cvv]
                  properties:
                    card_number:
                      type: string
                      description: "카드 번호 (토큰화 전)"
                    card_expiry:
                      type: string
                      pattern: '^\d{2}/\d{2}$'
                      example: "12/25"
                    card_cvv:
                      type: string
                      pattern: '^\d{3,4}$'
      responses:
        '201':
          description: 주문 생성 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  order:
                    $ref: '#/components/schemas/Order'
                  fds_result:
                    type: object
                    properties:
                      action:
                        type: string
                        enum: [approve, additional_auth_required, blocked]
                        description: |
                          - approve: 자동 승인 (위험도 낮음)
                          - additional_auth_required: 추가 인증 필요 (위험도 중간)
                          - blocked: 거래 차단 (위험도 높음)
                      risk_score:
                        type: integer
                      message:
                        type: string
        '400':
          description: 유효성 검증 실패 또는 재고 부족

    get:
      tags: [Orders]
      summary: 내 주문 목록 조회
      parameters:
        - in: query
          name: status
          schema:
            type: string
        - in: query
          name: page
          schema:
            type: integer
      responses:
        '200':
          description: 주문 목록
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Order'
                  meta:
                    $ref: '#/components/schemas/PaginationMeta'

  /orders/{order_id}:
    get:
      tags: [Orders]
      summary: 주문 상세 조회
      parameters:
        - in: path
          name: order_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 주문 상세
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'

  # ===== FDS API (Internal) =====
  /fds/evaluate:
    post:
      tags: [FDS]
      summary: 거래 위험 평가 (내부 API)
      description: |
        주문 생성 시 자동으로 호출됨. 외부 클라이언트는 직접 호출 불가.
        목표 응답 시간: 100ms 이내
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [user_id, order_id, amount, ip_address, user_agent]
              properties:
                user_id:
                  type: string
                  format: uuid
                order_id:
                  type: string
                  format: uuid
                amount:
                  type: number
                  format: decimal
                ip_address:
                  type: string
                  format: ipv4
                user_agent:
                  type: string
      responses:
        '200':
          description: 평가 완료
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'

  # ===== 관리자 API =====
  /admin/products:
    post:
      tags: [Admin]
      summary: 상품 등록 (관리자)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, price, stock_quantity, category]
              properties:
                name:
                  type: string
                description:
                  type: string
                price:
                  type: number
                  format: decimal
                  minimum: 0
                stock_quantity:
                  type: integer
                  minimum: 0
                category:
                  type: string
                image_url:
                  type: string
                  format: uri
      responses:
        '201':
          description: 상품 등록 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'
        '403':
          description: 권한 없음 (admin role 필요)

  /admin/orders/{order_id}/status:
    patch:
      tags: [Admin]
      summary: 주문 상태 변경 (관리자)
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: order_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  type: string
                  enum: [preparing, shipped, delivered, cancelled]
      responses:
        '200':
          description: 상태 변경 성공
        '403':
          description: 권한 없음

  /admin/fds/review-queue:
    get:
      tags: [Admin]
      summary: 수동 검토 큐 조회 (보안팀)
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: status
          schema:
            type: string
            enum: [pending, in_review, completed]
        - in: query
          name: page
          schema:
            type: integer
      responses:
        '200':
          description: 검토 큐 목록
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                        transaction:
                          $ref: '#/components/schemas/Transaction'
                        status:
                          type: string
                        added_at:
                          type: string
                          format: date-time
                  meta:
                    $ref: '#/components/schemas/PaginationMeta'
        '403':
          description: 권한 없음 (security_team role 필요)
