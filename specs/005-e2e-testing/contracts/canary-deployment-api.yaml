openapi: 3.0.3
info:
  title: 카나리 배포 관리 API
  description: |
    Flagger 기반 카나리 배포 관리 및 모니터링 API

    주요 기능:
    - 카나리 배포 시작 및 관리
    - 트래픽 분할 비율 조정 (10% → 50% → 100%)
    - 실시간 메트릭 모니터링 (에러율, 응답 시간)
    - 자동/수동 롤백
  version: 1.0.0
  contact:
    name: ShopFDS DevOps Team
    email: devops@shopfds.com

servers:
  - url: http://localhost:8000/api
    description: 로컬 개발 서버
  - url: https://staging.shopfds.com/api
    description: Staging 환경
  - url: https://api.shopfds.com/api
    description: Production 환경

tags:
  - name: Deployments
    description: 카나리 배포 관리
  - name: Metrics
    description: 배포 메트릭 조회

security:
  - BearerAuth: []

paths:
  /v1/canary/deployments:
    get:
      tags:
        - Deployments
      summary: 카나리 배포 목록 조회
      description: 진행 중이거나 완료된 카나리 배포 목록을 조회합니다.
      parameters:
        - name: service_name
          in: query
          schema:
            type: string
          description: 서비스 이름 필터 (예 ecommerce-backend, fds)
        - name: status
          in: query
          schema:
            type: string
            enum: [initializing, progressing, succeeded, failed, rollback]
          description: 배포 상태 필터
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
            minimum: 0
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  deployments:
                    type: array
                    items:
                      $ref: '#/components/schemas/CanaryDeployment'
                  total:
                    type: integer
                  limit:
                    type: integer
                  offset:
                    type: integer
              example:
                deployments:
                  - id: "660e8400-e29b-41d4-a716-446655440000"
                    service_name: "ecommerce-backend"
                    old_version: "v1.0.0"
                    new_version: "v1.1.0"
                    traffic_weight: 50
                    error_rate: 2.3
                    response_time_p95: 120
                    request_success_rate: 97.7
                    status: "progressing"
                    started_at: "2025-11-20T10:00:00Z"
                total: 1
                limit: 20
                offset: 0
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Deployments
      summary: 카나리 배포 시작
      description: 새 버전의 카나리 배포를 시작합니다.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StartCanaryDeploymentRequest'
            example:
              service_name: "ecommerce-backend"
              old_version: "v1.0.0"
              new_version: "v1.1.0"
              initial_traffic_weight: 10
              analysis_interval_sec: 60
              threshold_max_error_rate: 5.0
              threshold_max_response_time: 200
      responses:
        '201':
          description: 배포 시작 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CanaryDeployment'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/canary/deployments/{id}:
    get:
      tags:
        - Deployments
      summary: 카나리 배포 상세 조회
      description: 특정 배포의 상세 정보 및 메트릭 히스토리를 조회합니다.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: 배포 ID
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CanaryDeploymentDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/canary/deployments/{id}/traffic:
    patch:
      tags:
        - Deployments
      summary: 트래픽 분할 비율 수동 조정
      description: 카나리 배포의 트래픽 비율을 수동으로 조정합니다 (자동 진행 중지).
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTrafficWeightRequest'
            example:
              traffic_weight: 75
      responses:
        '200':
          description: 조정 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CanaryDeployment'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/canary/deployments/{id}/rollback:
    post:
      tags:
        - Deployments
      summary: 카나리 배포 롤백
      description: 카나리 배포를 중단하고 이전 버전으로 롤백합니다.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RollbackDeploymentRequest'
            example:
              reason: "에러율 5% 초과로 인한 수동 롤백"
      responses:
        '200':
          description: 롤백 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  status:
                    type: string
                    enum: [rollback]
                  rollback_reason:
                    type: string
                  message:
                    type: string
              example:
                id: "660e8400-e29b-41d4-a716-446655440000"
                status: "rollback"
                rollback_reason: "에러율 5% 초과로 인한 수동 롤백"
                message: "30초 이내에 이전 버전으로 롤백 완료됩니다."
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/canary/deployments/{id}/metrics:
    get:
      tags:
        - Metrics
      summary: 카나리 배포 실시간 메트릭 조회
      description: 배포 진행 중 실시간 메트릭 (에러율, 응답 시간, 트래픽 비율)을 조회합니다.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: interval
          in: query
          schema:
            type: string
            enum: ['1m', '5m', '15m', '1h']
            default: '1m'
          description: 메트릭 수집 간격
        - name: duration
          in: query
          schema:
            type: string
            enum: ['10m', '30m', '1h', '3h', '6h']
            default: '30m'
          description: 조회 기간
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  deployment_id:
                    type: string
                    format: uuid
                  current_traffic_weight:
                    type: integer
                  current_error_rate:
                    type: number
                  current_response_time_p95:
                    type: integer
                  current_request_success_rate:
                    type: number
                  metrics_history:
                    type: array
                    items:
                      $ref: '#/components/schemas/CanaryMetric'
                  threshold:
                    type: object
                    properties:
                      max_error_rate:
                        type: number
                      max_response_time:
                        type: integer
              example:
                deployment_id: "660e8400-e29b-41d4-a716-446655440000"
                current_traffic_weight: 50
                current_error_rate: 2.3
                current_response_time_p95: 120
                current_request_success_rate: 97.7
                metrics_history:
                  - measured_at: "2025-11-20T10:00:00Z"
                    traffic_weight: 10
                    error_rate: 1.5
                    response_time_p95: 110
                    request_success_rate: 98.5
                    total_requests: 1000
                    failed_requests: 15
                  - measured_at: "2025-11-20T10:01:00Z"
                    traffic_weight: 10
                    error_rate: 2.1
                    response_time_p95: 115
                    request_success_rate: 97.9
                    total_requests: 1050
                    failed_requests: 22
                threshold:
                  max_error_rate: 5.0
                  max_response_time: 200
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT 인증 토큰 (Authorization 헤더에 Bearer {token} 형식으로 전달)

  schemas:
    CanaryDeployment:
      type: object
      properties:
        id:
          type: string
          format: uuid
        service_name:
          type: string
          description: 서비스 이름
        old_version:
          type: string
          description: 이전 버전 (Semantic Versioning)
        new_version:
          type: string
          description: 새 버전 (Semantic Versioning)
        traffic_weight:
          type: integer
          minimum: 0
          maximum: 100
          description: 카나리 버전 트래픽 비율 (%)
        error_rate:
          type: number
          nullable: true
          description: 현재 에러율 (%)
        response_time_p95:
          type: integer
          nullable: true
          description: P95 응답 시간 (밀리초)
        request_success_rate:
          type: number
          nullable: true
          description: 요청 성공률 (%)
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true
        status:
          type: string
          enum: [initializing, progressing, succeeded, failed, rollback]
        rollback_reason:
          type: string
          nullable: true
        analysis_interval_sec:
          type: integer
        threshold_max_error_rate:
          type: number
        threshold_max_response_time:
          type: integer
        flagger_canary_name:
          type: string
        kubernetes_namespace:
          type: string
        created_by:
          type: string

    CanaryDeploymentDetail:
      allOf:
        - $ref: '#/components/schemas/CanaryDeployment'
        - type: object
          properties:
            metrics_summary:
              type: object
              properties:
                avg_error_rate:
                  type: number
                avg_response_time_p95:
                  type: integer
                total_requests:
                  type: integer
                total_failed_requests:
                  type: integer
            timeline:
              type: array
              items:
                type: object
                properties:
                  timestamp:
                    type: string
                    format: date-time
                  event:
                    type: string
                    enum: [started, traffic_increased, analysis_passed, analysis_failed, rollback_triggered, completed]
                  traffic_weight:
                    type: integer
                  details:
                    type: string

    StartCanaryDeploymentRequest:
      type: object
      required:
        - service_name
        - old_version
        - new_version
      properties:
        service_name:
          type: string
          enum: [ecommerce-backend, fds, ml-service, admin-dashboard-backend]
        old_version:
          type: string
          pattern: '^v\d+\.\d+\.\d+$'
          description: Semantic Versioning (예 v1.0.0)
        new_version:
          type: string
          pattern: '^v\d+\.\d+\.\d+$'
          description: Semantic Versioning (예 v1.1.0)
        initial_traffic_weight:
          type: integer
          minimum: 1
          maximum: 100
          default: 10
          description: 초기 트래픽 비율 (%)
        analysis_interval_sec:
          type: integer
          minimum: 30
          maximum: 600
          default: 60
          description: 메트릭 분석 주기 (초)
        threshold_max_error_rate:
          type: number
          minimum: 0
          maximum: 100
          default: 5.0
          description: 에러율 임계값 (%)
        threshold_max_response_time:
          type: integer
          minimum: 50
          maximum: 5000
          default: 200
          description: P95 응답 시간 임계값 (밀리초)

    UpdateTrafficWeightRequest:
      type: object
      required:
        - traffic_weight
      properties:
        traffic_weight:
          type: integer
          minimum: 0
          maximum: 100
          description: 새로운 트래픽 비율 (%)

    RollbackDeploymentRequest:
      type: object
      required:
        - reason
      properties:
        reason:
          type: string
          minLength: 1
          maxLength: 500
          description: 롤백 사유

    CanaryMetric:
      type: object
      properties:
        measured_at:
          type: string
          format: date-time
        traffic_weight:
          type: integer
        error_rate:
          type: number
        response_time_p95:
          type: integer
        request_success_rate:
          type: number
        total_requests:
          type: integer
        failed_requests:
          type: integer

    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: object
          nullable: true

  responses:
    BadRequest:
      description: 잘못된 요청
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "BAD_REQUEST"
            message: "old_version과 new_version이 동일합니다."
            details:
              field: "new_version"

    Unauthorized:
      description: 인증 실패
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "UNAUTHORIZED"
            message: "유효하지 않은 토큰입니다."

    Forbidden:
      description: 권한 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "FORBIDDEN"
            message: "카나리 배포 권한이 없습니다. DevOps 팀만 실행 가능합니다."

    NotFound:
      description: 리소스를 찾을 수 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "NOT_FOUND"
            message: "배포를 찾을 수 없습니다."

    InternalServerError:
      description: 서버 오류
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "INTERNAL_SERVER_ERROR"
            message: "서버 오류가 발생했습니다."
