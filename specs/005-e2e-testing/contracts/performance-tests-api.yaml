openapi: 3.0.3
info:
  title: 성능 테스트 관리 API
  description: |
    k6 기반 성능 테스트 실행 및 결과 조회 API

    주요 기능:
    - 성능 테스트 실행 (Spike, Soak, Stress, Load Test)
    - 실시간 메트릭 조회 (TPS, 응답 시간, 에러율)
    - 테스트 결과 히스토리 및 트렌드 분석
    - HTML 리포트 생성
  version: 1.0.0
  contact:
    name: ShopFDS QA Team
    email: qa@shopfds.com

servers:
  - url: http://localhost:8000/api
    description: 로컬 개발 서버
  - url: https://staging.shopfds.com/api
    description: Staging 환경
  - url: https://api.shopfds.com/api
    description: Production 환경

tags:
  - name: Tests
    description: 성능 테스트 관리
  - name: Metrics
    description: 메트릭 조회

security:
  - BearerAuth: []

paths:
  /v1/performance/tests:
    get:
      tags:
        - Tests
      summary: 성능 테스트 목록 조회
      description: 실행된 성능 테스트 목록을 조회합니다.
      parameters:
        - name: test_type
          in: query
          schema:
            type: string
            enum: [spike, soak, stress, load]
          description: 테스트 유형 필터
        - name: scenario_name
          in: query
          schema:
            type: string
          description: 시나리오 이름 필터
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, running, completed, failed]
          description: 테스트 상태 필터
        - name: environment
          in: query
          schema:
            type: string
            enum: [staging, production]
          description: 실행 환경 필터
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  tests:
                    type: array
                    items:
                      $ref: '#/components/schemas/PerformanceTest'
                  total:
                    type: integer
                  limit:
                    type: integer
                  offset:
                    type: integer
              example:
                tests:
                  - id: "990e8400-e29b-41d4-a716-446655440000"
                    test_type: "spike"
                    scenario_name: "블랙 프라이데이 시뮬레이션"
                    target_tps: 1000
                    actual_tps: 987.5
                    p95_response_time: 185
                    p99_response_time: 250
                    avg_response_time: 120
                    error_rate: 1.2
                    total_requests: 59250
                    failed_requests: 711
                    duration_sec: 60
                    virtual_users: 100
                    status: "completed"
                    environment: "staging"
                total: 15
                limit: 20
                offset: 0
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Tests
      summary: 성능 테스트 실행 트리거
      description: 성능 테스트를 비동기로 실행합니다.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TriggerPerformanceTestRequest'
            example:
              test_type: "spike"
              scenario_name: "FDS 평가 API 부하 테스트"
              target_tps: 1000
              duration_sec: 300
              virtual_users: 100
              environment: "staging"
              k6_script_path: "tests/performance/scenarios/fds-evaluation.js"
              thresholds:
                p95_response_time: 100
                error_rate: 5.0
      responses:
        '202':
          description: 테스트 실행 요청 접수
          content:
            application/json:
              schema:
                type: object
                properties:
                  test_id:
                    type: string
                    format: uuid
                  status:
                    type: string
                    enum: [pending]
                  message:
                    type: string
              example:
                test_id: "990e8400-e29b-41d4-a716-446655440000"
                status: "pending"
                message: "성능 테스트 실행이 시작되었습니다."
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/performance/tests/{id}:
    get:
      tags:
        - Tests
      summary: 성능 테스트 결과 상세 조회
      description: 특정 테스트의 상세 결과를 조회합니다.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PerformanceTestDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/performance/tests/{id}/metrics:
    get:
      tags:
        - Metrics
      summary: 성능 테스트 상세 메트릭 조회
      description: 테스트 진행 중 수집된 시계열 메트릭을 조회합니다.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: interval
          in: query
          schema:
            type: string
            enum: ['1s', '10s', '1m']
            default: '10s'
          description: 메트릭 수집 간격
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  test_id:
                    type: string
                    format: uuid
                  metrics:
                    type: array
                    items:
                      $ref: '#/components/schemas/PerformanceMetric'
                  summary:
                    type: object
                    properties:
                      avg_tps:
                        type: number
                      max_tps:
                        type: number
                      min_tps:
                        type: number
                      avg_response_time:
                        type: integer
                      max_response_time:
                        type: integer
                      min_response_time:
                        type: integer
              example:
                test_id: "990e8400-e29b-41d4-a716-446655440000"
                metrics:
                  - measured_at: "2025-11-20T12:00:00Z"
                    virtual_users: 100
                    requests_per_sec: 950.5
                    response_time_p95: 180
                    error_rate: 1.0
                  - measured_at: "2025-11-20T12:00:10Z"
                    virtual_users: 500
                    requests_per_sec: 980.2
                    response_time_p95: 190
                    error_rate: 1.5
                  - measured_at: "2025-11-20T12:00:20Z"
                    virtual_users: 1000
                    requests_per_sec: 987.5
                    response_time_p95: 185
                    error_rate: 1.2
                summary:
                  avg_tps: 972.7
                  max_tps: 987.5
                  min_tps: 950.5
                  avg_response_time: 185
                  max_response_time: 190
                  min_response_time: 180
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/performance/tests/{id}/report:
    get:
      tags:
        - Tests
      summary: 성능 테스트 HTML 리포트 조회
      description: k6에서 생성한 HTML 리포트 URL을 반환합니다.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  report_url:
                    type: string
                    format: uri
                    description: HTML 리포트 URL (S3)
                  report_generated_at:
                    type: string
                    format: date-time
              example:
                report_url: "https://s3.amazonaws.com/shopfds-performance-tests/reports/990e8400.html"
                report_generated_at: "2025-11-20T12:05:00Z"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT 인증 토큰 (Authorization 헤더에 Bearer {token} 형식으로 전달)

  schemas:
    PerformanceTest:
      type: object
      properties:
        id:
          type: string
          format: uuid
        test_type:
          type: string
          enum: [spike, soak, stress, load]
        scenario_name:
          type: string
        target_tps:
          type: integer
          description: 목표 TPS
        actual_tps:
          type: number
          nullable: true
          description: 실제 달성 TPS
        p95_response_time:
          type: integer
          nullable: true
          description: P95 응답 시간 (밀리초)
        p99_response_time:
          type: integer
          nullable: true
          description: P99 응답 시간 (밀리초)
        avg_response_time:
          type: integer
          nullable: true
          description: 평균 응답 시간 (밀리초)
        max_response_time:
          type: integer
          nullable: true
          description: 최대 응답 시간 (밀리초)
        error_rate:
          type: number
          nullable: true
          description: 에러율 (%)
        total_requests:
          type: integer
          nullable: true
        failed_requests:
          type: integer
          nullable: true
        duration_sec:
          type: integer
          description: 테스트 지속 시간 (초)
        virtual_users:
          type: integer
          description: 가상 사용자 수
        status:
          type: string
          enum: [pending, running, completed, failed]
        started_at:
          type: string
          format: date-time
          nullable: true
        completed_at:
          type: string
          format: date-time
          nullable: true
        k6_script_path:
          type: string
        environment:
          type: string
          enum: [staging, production]
        ci_build_id:
          type: string
          nullable: true
        executed_by:
          type: string

    PerformanceTestDetail:
      allOf:
        - $ref: '#/components/schemas/PerformanceTest'
        - type: object
          properties:
            thresholds:
              type: object
              properties:
                target_p95_response_time:
                  type: integer
                target_error_rate:
                  type: number
            threshold_violations:
              type: array
              items:
                type: object
                properties:
                  metric:
                    type: string
                  threshold:
                    type: number
                  actual:
                    type: number
                  passed:
                    type: boolean
            report_url:
              type: string
              format: uri
              nullable: true

    TriggerPerformanceTestRequest:
      type: object
      required:
        - test_type
        - scenario_name
        - target_tps
        - duration_sec
        - virtual_users
        - environment
        - k6_script_path
      properties:
        test_type:
          type: string
          enum: [spike, soak, stress, load]
        scenario_name:
          type: string
          minLength: 1
          maxLength: 255
        target_tps:
          type: integer
          minimum: 1
          description: 목표 TPS
        duration_sec:
          type: integer
          minimum: 10
          description: 테스트 지속 시간 (초)
        virtual_users:
          type: integer
          minimum: 1
          description: 가상 사용자 수
        environment:
          type: string
          enum: [staging, production]
        k6_script_path:
          type: string
          description: k6 스크립트 파일 경로
        thresholds:
          type: object
          properties:
            p95_response_time:
              type: integer
              description: P95 응답 시간 임계값 (밀리초)
            error_rate:
              type: number
              description: 에러율 임계값 (%)

    PerformanceMetric:
      type: object
      properties:
        measured_at:
          type: string
          format: date-time
        virtual_users:
          type: integer
        requests_per_sec:
          type: number
        response_time_p95:
          type: integer
        error_rate:
          type: number

    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: object
          nullable: true

  responses:
    BadRequest:
      description: 잘못된 요청
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "BAD_REQUEST"
            message: "target_tps는 1 이상이어야 합니다."
            details:
              field: "target_tps"

    Unauthorized:
      description: 인증 실패
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "UNAUTHORIZED"
            message: "유효하지 않은 토큰입니다."

    Forbidden:
      description: 권한 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "FORBIDDEN"
            message: "성능 테스트 실행 권한이 없습니다."

    NotFound:
      description: 리소스를 찾을 수 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "NOT_FOUND"
            message: "테스트를 찾을 수 없습니다."

    InternalServerError:
      description: 서버 오류
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "INTERNAL_SERVER_ERROR"
            message: "서버 오류가 발생했습니다."
