openapi: 3.0.3
info:
  title: API 테스트 관리 API
  description: |
    Newman (Postman CLI) 기반 API 통합 테스트 관리 API

    주요 기능:
    - Postman 컬렉션 기반 API 테스트 슈트 관리
    - Newman 실행 트리거 및 모니터링
    - 서비스 간 통합 테스트 (Ecommerce ↔ FDS ↔ ML)
    - 엔드포인트 커버리지 추적
    - Newman HTML 리포트 생성
  version: 1.0.0
  contact:
    name: ShopFDS QA Team
    email: qa@shopfds.com

servers:
  - url: http://localhost:8000/api
    description: 로컬 개발 서버
  - url: https://staging.shopfds.com/api
    description: Staging 환경
  - url: https://api.shopfds.com/api
    description: Production 환경

tags:
  - name: Suites
    description: API 테스트 슈트 관리
  - name: Runs
    description: 테스트 실행 및 결과

security:
  - BearerAuth: []

paths:
  /v1/api-tests/suites:
    get:
      tags:
        - Suites
      summary: API 테스트 슈트 목록 조회
      description: 등록된 Postman 컬렉션 기반 테스트 슈트 목록을 조회합니다.
      parameters:
        - name: service_name
          in: query
          schema:
            type: string
            enum: [ecommerce-backend, fds, ml-service, admin-dashboard-backend]
          description: 서비스 이름 필터
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  suites:
                    type: array
                    items:
                      $ref: '#/components/schemas/APITestSuite'
                  total:
                    type: integer
                  limit:
                    type: integer
                  offset:
                    type: integer
              example:
                suites:
                  - id: "aa0e8400-e29b-41d4-a716-446655440000"
                    name: "Ecommerce API 통합 테스트"
                    service_name: "ecommerce-backend"
                    postman_collection_id: "12345678-1234-1234-1234-123456789012"
                    postman_collection_path: "tests/api/collections/ecommerce-api.postman_collection.json"
                    total_tests: 45
                    description: "회원가입, 로그인, 상품, 장바구니, 주문 API 테스트"
                  - id: "aa0e8400-e29b-41d4-a716-446655440001"
                    name: "FDS API 통합 테스트"
                    service_name: "fds"
                    postman_collection_id: "12345678-1234-1234-1234-123456789013"
                    postman_collection_path: "tests/api/collections/fds-api.postman_collection.json"
                    total_tests: 15
                    description: "FDS 거래 평가, CTI 조회 API 테스트"
                total: 4
                limit: 20
                offset: 0
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Suites
      summary: API 테스트 슈트 생성
      description: 새로운 Postman 컬렉션을 등록합니다.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAPITestSuiteRequest'
            example:
              name: "Ecommerce → FDS 통합 플로우 테스트"
              service_name: "ecommerce-backend"
              postman_collection_id: "12345678-1234-1234-1234-123456789014"
              postman_collection_path: "tests/api/collections/ecommerce-fds-integration.postman_collection.json"
              description: "회원가입 → 결제 → FDS 평가 → OTP 검증 → 주문 완료"
      responses:
        '201':
          description: 생성 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APITestSuite'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/api-tests/suites/{id}:
    get:
      tags:
        - Suites
      summary: API 테스트 슈트 상세 조회
      description: 특정 슈트의 상세 정보 및 최근 실행 기록을 조회합니다.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APITestSuiteDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/api-tests/runs:
    get:
      tags:
        - Runs
      summary: API 테스트 실행 기록 조회
      description: Newman 실행 기록을 조회합니다.
      parameters:
        - name: suite_id
          in: query
          schema:
            type: string
            format: uuid
          description: 슈트 ID 필터
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, running, completed, failed]
          description: 실행 상태 필터
        - name: environment
          in: query
          schema:
            type: string
            enum: [local, staging, production]
          description: 실행 환경 필터
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  runs:
                    type: array
                    items:
                      $ref: '#/components/schemas/APITestRun'
                  total:
                    type: integer
                  limit:
                    type: integer
                  offset:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Runs
      summary: Newman 실행 트리거
      description: Postman 컬렉션을 Newman으로 실행합니다 (비동기).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TriggerNewmanRunRequest'
            example:
              suite_id: "aa0e8400-e29b-41d4-a716-446655440000"
              environment: "staging"
              iterations: 1
              delay_request_ms: 0
              bail: false
      responses:
        '202':
          description: 실행 요청 접수
          content:
            application/json:
              schema:
                type: object
                properties:
                  run_id:
                    type: string
                    format: uuid
                  newman_run_id:
                    type: string
                  status:
                    type: string
                    enum: [pending]
                  message:
                    type: string
              example:
                run_id: "bb0e8400-e29b-41d4-a716-446655440000"
                newman_run_id: "newman-20251120-120000"
                status: "pending"
                message: "Newman 실행이 시작되었습니다."
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/api-tests/runs/{id}:
    get:
      tags:
        - Runs
      summary: API 테스트 실행 결과 상세 조회
      description: Newman 실행 결과 및 각 테스트 케이스 결과를 조회합니다.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APITestRunDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/api-tests/runs/{id}/report:
    get:
      tags:
        - Runs
      summary: Newman HTML 리포트 조회
      description: Newman에서 생성한 HTML 리포트 URL을 반환합니다.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  report_url:
                    type: string
                    format: uri
                    description: Newman HTML 리포트 URL (S3)
                  report_generated_at:
                    type: string
                    format: date-time
              example:
                report_url: "https://s3.amazonaws.com/shopfds-api-tests/reports/bb0e8400.html"
                report_generated_at: "2025-11-20T12:10:00Z"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT 인증 토큰 (Authorization 헤더에 Bearer {token} 형식으로 전달)

  schemas:
    APITestSuite:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        service_name:
          type: string
          enum: [ecommerce-backend, fds, ml-service, admin-dashboard-backend]
        postman_collection_id:
          type: string
          description: Postman 컬렉션 ID
        postman_collection_path:
          type: string
          description: Postman 컬렉션 JSON 파일 경로
        total_tests:
          type: integer
          nullable: true
          description: 총 테스트 수 (마지막 실행 기준)
        description:
          type: string
          nullable: true

    APITestSuiteDetail:
      allOf:
        - $ref: '#/components/schemas/APITestSuite'
        - type: object
          properties:
            recent_runs:
              type: array
              items:
                $ref: '#/components/schemas/APITestRun'
              description: 최근 5회 실행 기록
            coverage:
              type: object
              properties:
                total_endpoints:
                  type: integer
                tested_endpoints:
                  type: integer
                coverage_percentage:
                  type: number

    CreateAPITestSuiteRequest:
      type: object
      required:
        - name
        - service_name
        - postman_collection_id
        - postman_collection_path
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
        service_name:
          type: string
          enum: [ecommerce-backend, fds, ml-service, admin-dashboard-backend]
        postman_collection_id:
          type: string
          description: Postman 컬렉션 ID
        postman_collection_path:
          type: string
          description: Postman 컬렉션 JSON 파일 경로
        description:
          type: string

    APITestRun:
      type: object
      properties:
        id:
          type: string
          format: uuid
        suite_id:
          type: string
          format: uuid
        newman_run_id:
          type: string
        total_tests:
          type: integer
          nullable: true
        passed_tests:
          type: integer
          nullable: true
        failed_tests:
          type: integer
          nullable: true
        skipped_tests:
          type: integer
          nullable: true
        status:
          type: string
          enum: [pending, running, completed, failed]
        started_at:
          type: string
          format: date-time
          nullable: true
        completed_at:
          type: string
          format: date-time
          nullable: true
        duration_ms:
          type: integer
          nullable: true
        environment:
          type: string
          enum: [local, staging, production]
        newman_report_path:
          type: string
          nullable: true
        ci_build_id:
          type: string
          nullable: true
        executed_by:
          type: string

    APITestRunDetail:
      allOf:
        - $ref: '#/components/schemas/APITestRun'
        - type: object
          properties:
            test_results:
              type: array
              items:
                $ref: '#/components/schemas/APITestResult'
            summary:
              type: object
              properties:
                pass_rate:
                  type: number
                  description: 테스트 통과율 (%)
                avg_response_time_ms:
                  type: integer
                failed_endpoints:
                  type: array
                  items:
                    type: string

    TriggerNewmanRunRequest:
      type: object
      required:
        - suite_id
        - environment
      properties:
        suite_id:
          type: string
          format: uuid
        environment:
          type: string
          enum: [local, staging, production]
        iterations:
          type: integer
          minimum: 1
          maximum: 100
          default: 1
          description: 컬렉션 반복 실행 횟수
        delay_request_ms:
          type: integer
          minimum: 0
          maximum: 10000
          default: 0
          description: 요청 간 지연 (밀리초)
        bail:
          type: boolean
          default: false
          description: 첫 실패 시 중단 여부

    APITestResult:
      type: object
      properties:
        id:
          type: string
          format: uuid
        api_test_suite_id:
          type: string
          format: uuid
        endpoint:
          type: string
          description: API 엔드포인트 (예 /api/products)
        http_method:
          type: string
          enum: [GET, POST, PUT, PATCH, DELETE]
        status_code:
          type: integer
          description: 응답 상태 코드
        test_status:
          type: string
          enum: [passed, failed, skipped]
        response_time_ms:
          type: integer
          description: 응답 시간 (밀리초)
        error_message:
          type: string
          nullable: true
        request_body:
          type: object
          nullable: true
        response_body:
          type: object
          nullable: true

    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: object
          nullable: true

  responses:
    BadRequest:
      description: 잘못된 요청
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "BAD_REQUEST"
            message: "suite_id는 필수입니다."
            details:
              field: "suite_id"

    Unauthorized:
      description: 인증 실패
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "UNAUTHORIZED"
            message: "유효하지 않은 토큰입니다."

    Forbidden:
      description: 권한 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "FORBIDDEN"
            message: "API 테스트 실행 권한이 없습니다."

    NotFound:
      description: 리소스를 찾을 수 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "NOT_FOUND"
            message: "테스트 슈트를 찾을 수 없습니다."

    InternalServerError:
      description: 서버 오류
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "INTERNAL_SERVER_ERROR"
            message: "서버 오류가 발생했습니다."
