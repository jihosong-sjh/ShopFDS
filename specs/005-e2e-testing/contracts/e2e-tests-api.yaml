openapi: 3.0.3
info:
  title: E2E 테스트 관리 API
  description: |
    Playwright 기반 E2E 테스트 시나리오 생성, 실행, 결과 조회 API

    주요 기능:
    - E2E 테스트 시나리오 CRUD
    - 테스트 실행 트리거 및 모니터링
    - 스크린샷 및 비디오 조회
    - CI/CD 파이프라인 통합
  version: 1.0.0
  contact:
    name: ShopFDS DevOps Team
    email: devops@shopfds.com

servers:
  - url: http://localhost:8000/api
    description: 로컬 개발 서버
  - url: https://staging.shopfds.com/api
    description: Staging 환경
  - url: https://api.shopfds.com/api
    description: Production 환경

tags:
  - name: Scenarios
    description: E2E 테스트 시나리오 관리
  - name: Runs
    description: 테스트 실행 및 결과 조회

security:
  - BearerAuth: []

paths:
  /v1/e2e/scenarios:
    get:
      tags:
        - Scenarios
      summary: E2E 테스트 시나리오 목록 조회
      description: 활성화된 E2E 테스트 시나리오 목록을 조회합니다.
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [draft, active, archived]
          description: 시나리오 상태 필터
        - name: test_type
          in: query
          schema:
            type: string
            enum: [functional, regression, smoke, integration]
          description: 테스트 유형 필터
        - name: browser
          in: query
          schema:
            type: string
            enum: [chromium, firefox, webkit]
          description: 브라우저 필터
        - name: tags
          in: query
          schema:
            type: array
            items:
              type: string
          description: 태그 필터 (쉼표로 구분)
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
          description: 조회 개수
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
            minimum: 0
          description: 시작 위치
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  scenarios:
                    type: array
                    items:
                      $ref: '#/components/schemas/E2EScenario'
                  total:
                    type: integer
                    description: 전체 시나리오 개수
                  limit:
                    type: integer
                  offset:
                    type: integer
              example:
                scenarios:
                  - id: "550e8400-e29b-41d4-a716-446655440000"
                    name: "회원가입부터 결제까지 전체 플로우"
                    description: "신규 사용자가 회원가입 후 상품 구매까지 완료하는 시나리오"
                    test_type: "functional"
                    browser: "chromium"
                    viewport:
                      width: 1920
                      height: 1080
                    status: "active"
                    priority: "critical"
                    tags: ["checkout", "payment", "fds"]
                total: 20
                limit: 20
                offset: 0
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Scenarios
      summary: E2E 테스트 시나리오 생성
      description: 새로운 E2E 테스트 시나리오를 생성합니다.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateE2EScenarioRequest'
            example:
              name: "고위험 거래 OTP 인증 플로우"
              description: "5백만원 이상 거래 시 OTP 인증 테스트"
              test_type: "functional"
              browser: "chromium"
              viewport:
                width: 1920
                height: 1080
              steps:
                - action: "goto"
                  url: "http://localhost:3000/login"
                - action: "fill"
                  selector: "[data-testid='email']"
                  value: "test@example.com"
                - action: "fill"
                  selector: "[data-testid='password']"
                  value: "password123"
                - action: "click"
                  selector: "[data-testid='login-button']"
              expected_results:
                - type: "url"
                  value: "/dashboard"
              priority: "high"
              timeout_ms: 60000
              retry_count: 2
              tags: ["fds", "otp", "payment"]
      responses:
        '201':
          description: 생성 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/E2EScenario'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/e2e/scenarios/{id}:
    get:
      tags:
        - Scenarios
      summary: E2E 테스트 시나리오 상세 조회
      description: 특정 시나리오의 상세 정보를 조회합니다.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: 시나리오 ID
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/E2EScenario'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags:
        - Scenarios
      summary: E2E 테스트 시나리오 수정
      description: 기존 시나리오를 수정합니다.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateE2EScenarioRequest'
      responses:
        '200':
          description: 수정 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/E2EScenario'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - Scenarios
      summary: E2E 테스트 시나리오 삭제
      description: 시나리오를 삭제합니다 (soft delete - archived 상태로 변경).
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: 삭제 성공
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/e2e/runs:
    get:
      tags:
        - Runs
      summary: E2E 테스트 실행 기록 목록 조회
      description: 테스트 실행 기록을 조회합니다.
      parameters:
        - name: scenario_id
          in: query
          schema:
            type: string
            format: uuid
          description: 시나리오 ID 필터
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, running, passed, failed, skipped]
          description: 실행 상태 필터
        - name: environment
          in: query
          schema:
            type: string
            enum: [local, staging, production]
          description: 실행 환경 필터
        - name: ci_build_id
          in: query
          schema:
            type: string
          description: CI 빌드 ID 필터
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  runs:
                    type: array
                    items:
                      $ref: '#/components/schemas/E2ETestRun'
                  total:
                    type: integer
                  limit:
                    type: integer
                  offset:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Runs
      summary: E2E 테스트 실행 트리거
      description: E2E 테스트를 실행합니다 (비동기).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TriggerE2ETestRequest'
            example:
              scenario_ids:
                - "550e8400-e29b-41d4-a716-446655440000"
                - "550e8400-e29b-41d4-a716-446655440001"
              environment: "staging"
              browser: "chromium"
              viewport:
                width: 1920
                height: 1080
      responses:
        '202':
          description: 실행 요청 접수
          content:
            application/json:
              schema:
                type: object
                properties:
                  run_id:
                    type: string
                    description: 실행 ID
                  status:
                    type: string
                    enum: [pending]
                  message:
                    type: string
              example:
                run_id: "gh-actions-12345"
                status: "pending"
                message: "E2E 테스트 실행이 시작되었습니다."
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/e2e/runs/{id}:
    get:
      tags:
        - Runs
      summary: E2E 테스트 실행 결과 조회
      description: 특정 테스트 실행의 상세 결과를 조회합니다.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: 실행 ID
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/E2ETestRunDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/e2e/runs/{id}/screenshots:
    get:
      tags:
        - Runs
      summary: E2E 테스트 스크린샷 조회
      description: 테스트 실행 중 캡처된 스크린샷 URL 목록을 조회합니다.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  screenshots:
                    type: array
                    items:
                      type: object
                      properties:
                        step:
                          type: string
                          description: 테스트 단계
                        url:
                          type: string
                          format: uri
                          description: 스크린샷 URL (S3)
                        timestamp:
                          type: string
                          format: date-time
              example:
                screenshots:
                  - step: "login"
                    url: "https://s3.amazonaws.com/shopfds-e2e-tests/screenshots/550e8400/login.png"
                    timestamp: "2025-11-20T10:30:00Z"
                  - step: "checkout"
                    url: "https://s3.amazonaws.com/shopfds-e2e-tests/screenshots/550e8400/checkout.png"
                    timestamp: "2025-11-20T10:31:00Z"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/e2e/runs/{id}/videos:
    get:
      tags:
        - Runs
      summary: E2E 테스트 비디오 조회
      description: 테스트 실행 비디오 녹화 URL을 조회합니다 (실패 시만 녹화).
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  video_url:
                    type: string
                    format: uri
                    description: 비디오 URL (S3)
                    nullable: true
              example:
                video_url: "https://s3.amazonaws.com/shopfds-e2e-tests/videos/550e8400.mp4"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT 인증 토큰 (Authorization 헤더에 Bearer {token} 형식으로 전달)

  schemas:
    E2EScenario:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
          nullable: true
        test_type:
          type: string
          enum: [functional, regression, smoke, integration]
        browser:
          type: string
          enum: [chromium, firefox, webkit]
        viewport:
          type: object
          properties:
            width:
              type: integer
            height:
              type: integer
        steps:
          type: array
          items:
            type: object
            properties:
              action:
                type: string
                enum: [goto, click, fill, select, wait]
              selector:
                type: string
              value:
                type: string
              url:
                type: string
        expected_results:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
                enum: [url, element, text]
              value:
                type: string
        status:
          type: string
          enum: [draft, active, archived]
        priority:
          type: string
          enum: [critical, high, medium, low]
        timeout_ms:
          type: integer
        retry_count:
          type: integer
        tags:
          type: array
          items:
            type: string
        created_by:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateE2EScenarioRequest:
      type: object
      required:
        - name
        - test_type
        - browser
        - viewport
        - steps
        - expected_results
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
        description:
          type: string
        test_type:
          type: string
          enum: [functional, regression, smoke, integration]
        browser:
          type: string
          enum: [chromium, firefox, webkit]
        viewport:
          type: object
          properties:
            width:
              type: integer
              minimum: 320
            height:
              type: integer
              minimum: 240
        steps:
          type: array
          minItems: 1
          items:
            type: object
        expected_results:
          type: array
          minItems: 1
          items:
            type: object
        priority:
          type: string
          enum: [critical, high, medium, low]
          default: medium
        timeout_ms:
          type: integer
          minimum: 5000
          maximum: 600000
          default: 30000
        retry_count:
          type: integer
          minimum: 0
          maximum: 5
          default: 2
        tags:
          type: array
          items:
            type: string

    UpdateE2EScenarioRequest:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        steps:
          type: array
          items:
            type: object
        expected_results:
          type: array
          items:
            type: object
        status:
          type: string
          enum: [draft, active, archived]
        priority:
          type: string
          enum: [critical, high, medium, low]
        timeout_ms:
          type: integer
        retry_count:
          type: integer
        tags:
          type: array
          items:
            type: string

    E2ETestRun:
      type: object
      properties:
        id:
          type: string
          format: uuid
        scenario_id:
          type: string
          format: uuid
        run_id:
          type: string
        status:
          type: string
          enum: [pending, running, passed, failed, skipped]
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true
        duration_ms:
          type: integer
          nullable: true
        browser:
          type: string
          enum: [chromium, firefox, webkit]
        viewport:
          type: object
        environment:
          type: string
          enum: [local, staging, production]
        ci_build_id:
          type: string
          nullable: true
        ci_commit_sha:
          type: string
          nullable: true
        executed_by:
          type: string

    E2ETestRunDetail:
      allOf:
        - $ref: '#/components/schemas/E2ETestRun'
        - type: object
          properties:
            screenshots:
              type: array
              items:
                type: object
                properties:
                  step:
                    type: string
                  url:
                    type: string
            video_url:
              type: string
              nullable: true
            error_logs:
              type: string
              nullable: true
            test_steps:
              type: array
              items:
                type: object
                properties:
                  step_number:
                    type: integer
                  step_name:
                    type: string
                  status:
                    type: string
                    enum: [passed, failed, skipped]
                  duration_ms:
                    type: integer
                  error_message:
                    type: string
                    nullable: true

    TriggerE2ETestRequest:
      type: object
      required:
        - scenario_ids
        - environment
      properties:
        scenario_ids:
          type: array
          minItems: 1
          items:
            type: string
            format: uuid
        environment:
          type: string
          enum: [local, staging, production]
        browser:
          type: string
          enum: [chromium, firefox, webkit]
          default: chromium
        viewport:
          type: object
          properties:
            width:
              type: integer
              default: 1920
            height:
              type: integer
              default: 1080

    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: object
          nullable: true

  responses:
    BadRequest:
      description: 잘못된 요청
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "BAD_REQUEST"
            message: "시나리오 이름은 필수입니다."
            details:
              field: "name"

    Unauthorized:
      description: 인증 실패
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "UNAUTHORIZED"
            message: "유효하지 않은 토큰입니다."

    Forbidden:
      description: 권한 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "FORBIDDEN"
            message: "시나리오 삭제 권한이 없습니다."

    NotFound:
      description: 리소스를 찾을 수 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "NOT_FOUND"
            message: "시나리오를 찾을 수 없습니다."

    InternalServerError:
      description: 서버 오류
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "INTERNAL_SERVER_ERROR"
            message: "서버 오류가 발생했습니다."
