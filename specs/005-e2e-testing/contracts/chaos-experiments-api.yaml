openapi: 3.0.3
info:
  title: Chaos Engineering 실험 API
  description: |
    Litmus Chaos 기반 장애 시뮬레이션 실험 관리 API

    주요 기능:
    - 장애 실험 생성 및 관리 (Pod 종료, 네트워크 지연, 리소스 부족 등)
    - 실험 실행 및 모니터링
    - 복구 시간 측정 및 검증
    - 정상 상태 가설 검증
  version: 1.0.0
  contact:
    name: ShopFDS SRE Team
    email: sre@shopfds.com

servers:
  - url: http://localhost:8000/api
    description: 로컬 개발 서버
  - url: https://staging.shopfds.com/api
    description: Staging 환경
  - url: https://api.shopfds.com/api
    description: Production 환경

tags:
  - name: Experiments
    description: 장애 실험 관리
  - name: Observations
    description: 실험 관찰 결과

security:
  - BearerAuth: []

paths:
  /v1/chaos/experiments:
    get:
      tags:
        - Experiments
      summary: 장애 실험 목록 조회
      description: 스케줄되거나 완료된 장애 실험 목록을 조회합니다.
      parameters:
        - name: experiment_type
          in: query
          schema:
            type: string
            enum: [pod_delete, network_latency, network_loss, cpu_stress, memory_stress, disk_stress]
          description: 실험 유형 필터
        - name: target_service
          in: query
          schema:
            type: string
          description: 대상 서비스 필터
        - name: status
          in: query
          schema:
            type: string
            enum: [scheduled, running, completed, stopped, failed]
          description: 실험 상태 필터
        - name: environment
          in: query
          schema:
            type: string
            enum: [staging, production]
          description: 실행 환경 필터
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  experiments:
                    type: array
                    items:
                      $ref: '#/components/schemas/ChaosExperiment'
                  total:
                    type: integer
                  limit:
                    type: integer
                  offset:
                    type: integer
              example:
                experiments:
                  - id: "770e8400-e29b-41d4-a716-446655440000"
                    name: "FDS Pod 무작위 종료 복원력 테스트"
                    experiment_type: "pod_delete"
                    target_service: "fds-backend"
                    hypothesis: "FDS Pod 종료 시 30초 이내 자동 복구됨"
                    duration_sec: 60
                    status: "completed"
                    result: "passed"
                    recovery_time_sec: 25
                    environment: "staging"
                total: 5
                limit: 20
                offset: 0
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Experiments
      summary: 장애 실험 생성
      description: 새로운 장애 실험을 생성합니다 (스케줄만 하고 실행하지 않음).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateChaosExperimentRequest'
            example:
              name: "FDS 네트워크 지연 500ms 복원력 테스트"
              experiment_type: "network_latency"
              target_service: "fds-backend"
              target_pod: null
              hypothesis: "FDS API 500ms 지연 시 Timeout 재시도 로직으로 정상 처리됨"
              steady_state_hypothesis:
                error_rate: "<5%"
                response_time_p95: "<200ms"
              method:
                network_latency: "500"
                jitter: "50"
                total_chaos_duration: "120"
                chaos_interval: "10"
              duration_sec: 120
              environment: "staging"
              approval_required: false
      responses:
        '201':
          description: 생성 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChaosExperiment'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/chaos/experiments/{id}:
    get:
      tags:
        - Experiments
      summary: 장애 실험 상세 조회
      description: 특정 실험의 상세 정보 및 관찰 결과를 조회합니다.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChaosExperimentDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/chaos/experiments/{id}/start:
    post:
      tags:
        - Experiments
      summary: 장애 실험 시작
      description: 스케줄된 실험을 실행합니다 (프로덕션 환경은 승인 필요).
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                approval_code:
                  type: string
                  description: 프로덕션 환경 실행 시 승인 코드 (SRE 팀 발급)
            example:
              approval_code: "SRE-2025-11-20-PROD-001"
      responses:
        '200':
          description: 실험 시작 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  status:
                    type: string
                    enum: [running]
                  started_at:
                    type: string
                    format: date-time
                  message:
                    type: string
              example:
                id: "770e8400-e29b-41d4-a716-446655440000"
                status: "running"
                started_at: "2025-11-20T11:00:00Z"
                message: "장애 실험이 시작되었습니다. 60초 동안 진행됩니다."
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: 승인 필요
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "APPROVAL_REQUIRED"
                message: "프로덕션 환경 실험은 SRE 팀 승인이 필요합니다."
                details:
                  approval_url: "https://shopfds.com/chaos/approvals/770e8400"
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/chaos/experiments/{id}/stop:
    post:
      tags:
        - Experiments
      summary: 장애 실험 중단
      description: 진행 중인 실험을 즉시 중단합니다 (긴급 상황).
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - reason
              properties:
                reason:
                  type: string
                  minLength: 1
                  maxLength: 500
            example:
              reason: "시스템 전체 다운 위험으로 긴급 중단"
      responses:
        '200':
          description: 중단 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  status:
                    type: string
                    enum: [stopped]
                  stopped_at:
                    type: string
                    format: date-time
                  message:
                    type: string
              example:
                id: "770e8400-e29b-41d4-a716-446655440000"
                status: "stopped"
                stopped_at: "2025-11-20T11:05:00Z"
                message: "장애 실험이 중단되었습니다."
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/chaos/experiments/{id}/observations:
    get:
      tags:
        - Observations
      summary: 실험 관찰 결과 조회
      description: 실험 진행 중 수집된 메트릭 및 관찰 결과를 조회합니다.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: observation_type
          in: query
          schema:
            type: string
            enum: [metric, event, probe]
          description: 관찰 유형 필터
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  experiment_id:
                    type: string
                    format: uuid
                  observations:
                    type: array
                    items:
                      $ref: '#/components/schemas/ChaosObservation'
                  summary:
                    type: object
                    properties:
                      total_observations:
                        type: integer
                      recovery_time_sec:
                        type: integer
                        nullable: true
                      steady_state_maintained:
                        type: boolean
              example:
                experiment_id: "770e8400-e29b-41d4-a716-446655440000"
                observations:
                  - id: "880e8400-e29b-41d4-a716-446655440000"
                    observed_at: "2025-11-20T11:00:10Z"
                    metric_name: "pod_status"
                    metric_value: "Terminating"
                    observation_type: "event"
                    notes: "FDS Pod 종료 시작"
                  - id: "880e8400-e29b-41d4-a716-446655440001"
                    observed_at: "2025-11-20T11:00:25Z"
                    metric_name: "pod_status"
                    metric_value: "Running"
                    observation_type: "event"
                    notes: "FDS Pod 복구 완료"
                  - id: "880e8400-e29b-41d4-a716-446655440002"
                    observed_at: "2025-11-20T11:00:30Z"
                    metric_name: "error_rate"
                    metric_value: "2.3%"
                    observation_type: "metric"
                    notes: "에러율 정상 범위 유지"
                summary:
                  total_observations: 3
                  recovery_time_sec: 25
                  steady_state_maintained: true
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT 인증 토큰 (Authorization 헤더에 Bearer {token} 형식으로 전달)

  schemas:
    ChaosExperiment:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        experiment_type:
          type: string
          enum: [pod_delete, network_latency, network_loss, cpu_stress, memory_stress, disk_stress]
        target_service:
          type: string
        target_pod:
          type: string
          nullable: true
        hypothesis:
          type: string
        steady_state_hypothesis:
          type: object
          description: 정상 상태 가설 (JSON)
        method:
          type: object
          description: 실험 방법 (JSON)
        duration_sec:
          type: integer
        status:
          type: string
          enum: [scheduled, running, completed, stopped, failed]
        started_at:
          type: string
          format: date-time
          nullable: true
        completed_at:
          type: string
          format: date-time
          nullable: true
        result:
          type: string
          enum: [passed, failed]
          nullable: true
        recovery_time_sec:
          type: integer
          nullable: true
        chaos_engine_name:
          type: string
        kubernetes_namespace:
          type: string
        environment:
          type: string
          enum: [staging, production]
        approval_required:
          type: boolean
        approved_by:
          type: string
          nullable: true
        created_by:
          type: string

    ChaosExperimentDetail:
      allOf:
        - $ref: '#/components/schemas/ChaosExperiment'
        - type: object
          properties:
            observations_count:
              type: integer
            timeline:
              type: array
              items:
                type: object
                properties:
                  timestamp:
                    type: string
                    format: date-time
                  event:
                    type: string
                    enum: [created, started, chaos_injected, recovery_started, recovery_completed, stopped, failed]
                  details:
                    type: string

    CreateChaosExperimentRequest:
      type: object
      required:
        - name
        - experiment_type
        - target_service
        - hypothesis
        - steady_state_hypothesis
        - method
        - duration_sec
        - environment
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
        experiment_type:
          type: string
          enum: [pod_delete, network_latency, network_loss, cpu_stress, memory_stress, disk_stress]
        target_service:
          type: string
          enum: [ecommerce-backend, fds-backend, ml-service, admin-dashboard-backend]
        target_pod:
          type: string
          nullable: true
          description: 특정 Pod 지정 (null이면 무작위 선택)
        hypothesis:
          type: string
          minLength: 1
          description: 실험 가설 (예 "Pod 종료 시 30초 이내 복구됨")
        steady_state_hypothesis:
          type: object
          description: 정상 상태 가설 (예 {"error_rate" "<5%", "response_time_p95" "<200ms"})
        method:
          type: object
          description: 실험 방법 (실험 유형에 따라 다름)
        duration_sec:
          type: integer
          minimum: 10
          maximum: 600
          description: 실험 지속 시간 (초)
        environment:
          type: string
          enum: [staging, production]
        approval_required:
          type: boolean
          default: true
          description: 승인 필요 여부 (프로덕션은 강제 true)

    ChaosObservation:
      type: object
      properties:
        id:
          type: string
          format: uuid
        chaos_experiment_id:
          type: string
          format: uuid
        observed_at:
          type: string
          format: date-time
        metric_name:
          type: string
        metric_value:
          type: string
        observation_type:
          type: string
          enum: [metric, event, probe]
        notes:
          type: string
          nullable: true

    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: object
          nullable: true

  responses:
    BadRequest:
      description: 잘못된 요청
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "BAD_REQUEST"
            message: "duration_sec는 10초 이상 600초 이하여야 합니다."
            details:
              field: "duration_sec"

    Unauthorized:
      description: 인증 실패
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "UNAUTHORIZED"
            message: "유효하지 않은 토큰입니다."

    Forbidden:
      description: 권한 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "FORBIDDEN"
            message: "장애 실험 실행 권한이 없습니다. SRE 팀만 실행 가능합니다."

    NotFound:
      description: 리소스를 찾을 수 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "NOT_FOUND"
            message: "실험을 찾을 수 없습니다."

    InternalServerError:
      description: 서버 오류
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "INTERNAL_SERVER_ERROR"
            message: "서버 오류가 발생했습니다."
