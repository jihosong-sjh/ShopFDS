openapi: 3.0.0
info:
  title: Advanced FDS API
  description: 실시간 사기 탐지 시스템 고도화 - FDS 평가 API
  version: 1.0.0
  contact:
    name: FDS Team
    email: fds@shopfds.com

servers:
  - url: http://localhost:8001/v1
    description: 개발 서버
  - url: https://api.shopfds.com/v1
    description: 프로덕션 서버

tags:
  - name: Device Fingerprint
    description: 디바이스 핑거프린팅 기반 탐지
  - name: Behavior Pattern
    description: 행동 패턴 분석 기반 봇 탐지
  - name: Blacklist
    description: 블랙리스트 관리
  - name: FDS Evaluation
    description: 통합 FDS 평가
  - name: Rules
    description: 사기 탐지 룰 관리
  - name: XAI
    description: 설명 가능한 AI (SHAP/LIME)

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT 토큰 필수

  schemas:
    ErrorResponse:
      type: object
      properties:
        error_code:
          type: string
          example: "FDS001"
        message:
          type: string
          example: "거래 평가 실패"
        timestamp:
          type: string
          format: date-time
        request_id:
          type: string
          format: uuid

    DeviceFingerprintRequest:
      type: object
      required:
        - canvas_hash
        - webgl_hash
        - audio_hash
        - cpu_cores
        - memory_size
        - screen_resolution
        - timezone
        - language
        - user_agent
      properties:
        canvas_hash:
          type: string
          description: Canvas API 해시
          example: "a1b2c3d4e5f6"
        webgl_hash:
          type: string
          description: WebGL API 해시
          example: "b2c3d4e5f6g7"
        audio_hash:
          type: string
          description: Audio API 해시
          example: "c3d4e5f6g7h8"
        cpu_cores:
          type: integer
          example: 8
        memory_size:
          type: integer
          description: MB 단위
          example: 16384
        screen_resolution:
          type: string
          example: "1920x1080"
        timezone:
          type: string
          example: "Asia/Seoul"
        language:
          type: string
          example: "ko-KR"
        user_agent:
          type: string
          example: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"

    DeviceFingerprintResponse:
      type: object
      properties:
        device_id:
          type: string
          format: uuid
          description: 생성된 디바이스 고유 ID
          example: "a1b2c3d4-e5f6-47a8-9b0c-1d2e3f4a5b6c"
        created_at:
          type: string
          format: date-time
        last_seen_at:
          type: string
          format: date-time
        is_blacklisted:
          type: boolean
        blacklist_reason:
          type: string
        risk_score:
          type: integer
          description: 0-100, 높을수록 사기 의심
          example: 15

    BehaviorPatternRequest:
      type: object
      required:
        - session_id
        - user_id
        - mouse_movements
        - keyboard_events
        - clickstream
      properties:
        session_id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        mouse_movements:
          type: array
          description: 마우스 이동 데이터 (0.1초 단위 샘플링)
          items:
            type: object
            properties:
              timestamp:
                type: number
                example: 1234567890.123
              x:
                type: integer
              y:
                type: integer
              speed:
                type: number
                description: 픽셀/초
              acceleration:
                type: number
              curvature:
                type: number
                description: 0(직선) ~ 1(극도로 곡선)
        keyboard_events:
          type: array
          description: 키보드 입력 패턴
          items:
            type: object
            properties:
              timestamp:
                type: number
              key:
                type: string
              duration:
                type: integer
                description: 키 입력 지속 시간 (ms)
        clickstream:
          type: array
          description: 페이지 이동 기록
          items:
            type: object
            properties:
              page:
                type: string
              timestamp:
                type: number
              duration:
                type: integer
                description: 페이지 체류 시간 (초)

    BehaviorPatternResponse:
      type: object
      properties:
        session_id:
          type: string
          format: uuid
        bot_score:
          type: integer
          description: 0-100, 높을수록 봇 의심
          example: 15
        bot_indicators:
          type: array
          items:
            type: string
            example: "direct_mouse_movement"
        risk_score:
          type: integer
          example: 20

    BlacklistCheckRequest:
      type: object
      required:
        - device_id
      properties:
        device_id:
          type: string
          format: uuid

    BlacklistCheckResponse:
      type: object
      properties:
        is_blacklisted:
          type: boolean
        reason:
          type: string
        expires_at:
          type: string
          format: date-time
        risk_level:
          type: string
          enum: [low, medium, high, blocked]

    AdvancedFDSEvaluationRequest:
      type: object
      required:
        - transaction_id
        - user_id
        - device_id
        - ip_address
        - card_bin
        - order_amount
        - shipping_address
        - email
        - phone
      properties:
        transaction_id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        device_id:
          type: string
          format: uuid
          description: 디바이스 핑거프린트
        ip_address:
          type: string
          format: ipv4
        card_bin:
          type: string
          description: 카드 BIN (앞 6자리)
          example: "424242"
        order_amount:
          type: number
          format: double
          example: 150000.00
        order_currency:
          type: string
          default: "KRW"
          example: "KRW"
        shipping_address:
          type: string
          example: "서울시 강남구 테헤란로 123"
        shipping_country:
          type: string
          default: "KR"
        email:
          type: string
          format: email
        phone:
          type: string
          example: "010-1234-5678"
        session_id:
          type: string
          format: uuid
        user_agent:
          type: string

    AdvancedFDSEvaluationResponse:
      type: object
      properties:
        transaction_id:
          type: string
          format: uuid
        overall_risk_score:
          type: integer
          description: 0-100, 종합 위험 점수
          example: 65
        risk_level:
          type: string
          enum: [low, medium, high, blocked]
          example: "high"
        decision:
          type: string
          enum: [allow, additional_auth_required, block, manual_review]
          example: "additional_auth_required"
        requires_3d_secure:
          type: boolean
        requires_otp:
          type: boolean
        require_phone_verification:
          type: boolean

        device_analysis:
          type: object
          properties:
            device_id:
              type: string
              format: uuid
            is_blacklisted:
              type: boolean
            risk_score:
              type: integer
            timezone_mismatch:
              type: boolean
            language_mismatch:
              type: boolean

        behavior_analysis:
          type: object
          properties:
            bot_score:
              type: integer
            is_bot_detected:
              type: boolean
            risk_indicators:
              type: array
              items:
                type: string

        network_analysis:
          type: object
          properties:
            geoip_country:
              type: string
            is_tor:
              type: boolean
            is_vpn:
              type: boolean
            is_proxy:
              type: boolean
            country_mismatch:
              type: boolean
            asn_risk:
              type: string
            risk_score:
              type: integer

        rule_results:
          type: array
          items:
            type: object
            properties:
              rule_id:
                type: string
                format: uuid
              rule_name:
                type: string
              matched:
                type: boolean
              risk_score:
                type: integer

        ml_ensemble_result:
          type: object
          properties:
            random_forest_score:
              type: number
            xgboost_score:
              type: number
            autoencoder_score:
              type: number
            lstm_score:
              type: number
            ensemble_score:
              type: number
            prediction_confidence:
              type: number

        external_verification:
          type: object
          properties:
            email_reputation:
              type: object
              properties:
                service: { type: string, example: "EmailRep" }
                reputation_score: { type: integer, description: "0-100" }
                is_compromised: { type: boolean }
            phone_verification:
              type: object
              properties:
                service: { type: string, example: "Numverify" }
                is_valid: { type: boolean }
                carrier: { type: string }
            card_bin_check:
              type: object
              properties:
                issuing_country: { type: string }
                bank_name: { type: string }
                card_type: { type: string }
            breach_check:
              type: object
              properties:
                service: { type: string, example: "HaveIBeenPwned" }
                found_in_breach: { type: boolean }
                breach_count: { type: integer }

        evaluated_at:
          type: string
          format: date-time
        evaluation_time_ms:
          type: integer

    FraudRule:
      type: object
      properties:
        rule_id:
          type: string
          format: uuid
        rule_name:
          type: string
          example: "테스트 카드 차단"
        rule_category:
          type: string
          enum: [payment, account, shipping]
        rule_description:
          type: string
        risk_score:
          type: integer
          example: 100
        is_active:
          type: boolean
        priority:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateRuleRequest:
      type: object
      required:
        - rule_name
        - rule_category
        - rule_logic
        - risk_score
      properties:
        rule_name:
          type: string
          example: "카드 테스팅 탐지"
        rule_category:
          type: string
          enum: [payment, account, shipping]
        rule_description:
          type: string
        rule_logic:
          type: object
          description: 룰 실행 로직 (JSON 형식)
          example:
            type: "pattern_matching"
            field: "card_failures"
            operator: "exceeds"
            threshold: 5
            time_window: 3600
        risk_score:
          type: integer
          minimum: 0
          maximum: 100
        priority:
          type: integer
          default: 0

    XAIExplanationResponse:
      type: object
      properties:
        transaction_id:
          type: string
          format: uuid
        overall_risk_score:
          type: integer
        top_risk_factors:
          type: array
          description: 상위 5개 위험 요인
          items:
            type: object
            properties:
              factor_name:
                type: string
                example: "타임존 불일치"
              contribution:
                type: integer
                description: 위험 점수에 대한 기여도
                example: 20
              rank:
                type: integer
              explanation:
                type: string
                example: "브라우저 타임존(미국)이 결제 IP 국가(한국)와 불일치"

        shap_analysis:
          type: object
          description: SHAP 값 기반 feature 기여도
          properties:
            base_value:
              type: number
              description: 평균 위험 점수
            shap_values:
              type: array
              items:
                type: object
                properties:
                  feature:
                    type: string
                  shap_value:
                    type: number
                  feature_value:
                    type: string

        lime_explanation:
          type: object
          description: 로컬 모델 근사 분석
          properties:
            local_prediction:
              type: number
            feature_contributions:
              type: array
              items:
                type: object
                properties:
                  feature:
                    type: string
                  weight:
                    type: number

        counterfactual_scenarios:
          type: array
          description: "만약 이 feature를 변경하면..." 시나리오
          items:
            type: object
            properties:
              scenario:
                type: string
                example: "타임존을 한국(Asia/Seoul)으로 변경하면"
              new_risk_score:
                type: integer
                example: 45
              risk_reduction:
                type: integer
                example: 20

        generated_at:
          type: string
          format: date-time
        explanation_time_ms:
          type: integer

security:
  - BearerAuth: []

paths:
  /fds/device-fingerprint:
    post:
      tags:
        - Device Fingerprint
      summary: 디바이스 핑거프린트 수집
      description: 클라이언트 JavaScript에서 수집한 디바이스 정보를 저장하고 고유 디바이스 ID 생성
      operationId: collectDeviceFingerprint
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeviceFingerprintRequest'
      responses:
        '200':
          description: 디바이스 핑거프린트 생성 완료
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeviceFingerprintResponse'
        '400':
          description: 잘못된 요청
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: 속도 제한 (Rate Limit) 초과
        '500':
          description: 서버 오류
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /fds/behavior-pattern:
    post:
      tags:
        - Behavior Pattern
      summary: 행동 패턴 데이터 전송
      description: 마우스, 키보드, 클릭스트림 행동 패턴 수집
      operationId: collectBehaviorPattern
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BehaviorPatternRequest'
      responses:
        '200':
          description: 행동 패턴 분석 완료
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BehaviorPatternResponse'
        '400':
          description: 잘못된 요청
        '500':
          description: 서버 오류

  /fds/blacklist/device/{device_id}:
    get:
      tags:
        - Blacklist
      summary: 디바이스 블랙리스트 조회
      description: 특정 디바이스 ID가 블랙리스트에 등록되었는지 확인
      operationId: checkDeviceBlacklist
      parameters:
        - name: device_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 블랙리스트 확인 결과
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BlacklistCheckResponse'
        '404':
          description: 디바이스 미등록
        '500':
          description: 서버 오류

  /fds/evaluate-advanced:
    post:
      tags:
        - FDS Evaluation
      summary: 고도화된 FDS 평가 (통합)
      description: |
        디바이스, 행동, 네트워크, 룰, 앙상블 ML 모델을 모두 종합하여 거래 위험도 평가

        평가 프로세스:
        1. 디바이스 핑거프린트 확인 및 블랙리스트 검사
        2. 행동 패턴 분석 (봇 탐지)
        3. 네트워크 분석 (TOR/VPN, GeoIP, ASN)
        4. 사기 탐지 룰 30개 실행
        5. 앙상블 ML 모델 예측 (Random Forest, XGBoost, Autoencoder, LSTM)
        6. 외부 서비스 검증 (EmailRep, Numverify, BIN, HaveIBeenPwned)
        7. 종합 위험 점수 계산 및 의사결정
      operationId: evaluateAdvancedFDS
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdvancedFDSEvaluationRequest'
      responses:
        '200':
          description: FDS 평가 완료
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdvancedFDSEvaluationResponse'
        '400':
          description: 잘못된 요청
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '408':
          description: 평가 타임아웃 (외부 API 지연)
        '429':
          description: 속도 제한 초과
        '500':
          description: 서버 오류
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /fds/rules:
    get:
      tags:
        - Rules
      summary: 사기 탐지 룰 목록 조회
      description: 활성화된 사기 탐지 룰 전체 목록 조회
      operationId: listFraudRules
      parameters:
        - name: category
          in: query
          schema:
            type: string
            enum: [payment, account, shipping]
          description: 룰 카테고리로 필터링
        - name: is_active
          in: query
          schema:
            type: boolean
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: 룰 목록
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  rules:
                    type: array
                    items:
                      $ref: '#/components/schemas/FraudRule'
        '500':
          description: 서버 오류

    post:
      tags:
        - Rules
      summary: 새 사기 탐지 룰 추가
      description: 보안팀이 새로운 사기 탐지 룰 추가
      operationId: createFraudRule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRuleRequest'
      responses:
        '201':
          description: 룰 생성 완료
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FraudRule'
        '400':
          description: 잘못된 요청
        '403':
          description: 권한 없음 (관리자만)
        '500':
          description: 서버 오류

  /fds/xai/{transaction_id}:
    get:
      tags:
        - XAI
      summary: XAI 분석 결과 조회
      description: 특정 거래의 SHAP/LIME 기반 설명 가능한 AI 분석 결과 조회
      operationId: getXAIExplanation
      parameters:
        - name: transaction_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: XAI 분석 결과
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/XAIExplanationResponse'
        '404':
          description: 거래 미등록 또는 분석 미생성
        '408':
          description: SHAP 계산 타임아웃 (5초 초과)
        '500':
          description: 서버 오류
