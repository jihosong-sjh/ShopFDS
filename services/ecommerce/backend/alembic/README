# Alembic 마이그레이션 가이드

## 디렉토리 구조

- `env.py`: Alembic 환경 설정 (비동기 SQLAlchemy 지원)
- `script.py.mako`: 마이그레이션 파일 템플릿
- `versions/`: 생성된 마이그레이션 파일 저장 디렉토리

## 주요 명령어

### 새 마이그레이션 생성 (자동 감지)
```bash
alembic revision --autogenerate -m "Add users table"
```

### 마이그레이션 적용
```bash
# 최신 버전으로 업그레이드
alembic upgrade head

# 특정 버전으로 업그레이드
alembic upgrade abc123

# 한 단계만 업그레이드
alembic upgrade +1
```

### 마이그레이션 되돌리기
```bash
# 한 단계 되돌리기
alembic downgrade -1

# 특정 버전으로 되돌리기
alembic downgrade abc123

# 모든 마이그레이션 되돌리기
alembic downgrade base
```

### 마이그레이션 히스토리 확인
```bash
# 현재 버전 확인
alembic current

# 마이그레이션 히스토리 보기
alembic history

# 상세 히스토리 (verbose)
alembic history --verbose
```

### SQL 스크립트 생성 (적용하지 않음)
```bash
alembic upgrade head --sql > migration.sql
```

## 환경 변수

`DATABASE_URL` 환경 변수를 설정하거나 `.env` 파일에 정의하세요:

```env
DATABASE_URL=postgresql+asyncpg://user:password@localhost:5432/dbname
```

## 주의사항

1. **자동 마이그레이션 검증**: `--autogenerate`로 생성된 마이그레이션은 반드시 수동으로 검토하세요.
2. **데이터 손실 주의**: 컬럼 삭제, 테이블 삭제 시 데이터 백업 필수.
3. **프로덕션 배포**: 마이그레이션 적용 전 스테이징 환경에서 테스트하세요.
4. **비동기 지원**: 본 프로젝트는 `asyncpg`를 사용하여 비동기 SQLAlchemy를 지원합니다.
